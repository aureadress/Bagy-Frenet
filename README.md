# üöÄ Integra√ß√£o Bagy ‚Üí Frenet

Webhook Flask robusto e otimizado para **capturar pedidos faturados da Bagy**, salvar localmente com **painel web de visualiza√ß√£o**, e permitir que voc√™ crie etiquetas manualmente na **Frenet** com monitoramento autom√°tico de entrega.

## üéØ Como Funciona

1. **üì• Bagy dispara webhook** quando pedido √© faturado (fulfillment_status = "invoiced")
2. **üöÄ Sistema cria pedido automaticamente** na Frenet via API Shipments
3. **üè∑Ô∏è Pedido aparece** em "Gerencie suas etiquetas" no painel Frenet
4. **üë§ Voc√™ acessa** painel.frenet.com.br e escolhe a transportadora
5. **üìÑ Gera etiqueta** manualmente e imprime
6. **üì¶ Sistema monitora** rastreio automaticamente
7. **‚úÖ Atualiza Bagy** quando pedido √© entregue

## ‚ú® Funcionalidades

- ‚úÖ **Recebe webhooks** da Bagy quando pedidos s√£o faturados
- ‚úÖ **Cria pedidos automaticamente** na Frenet via API Shipments
- ‚úÖ **Pedidos aparecem** em "Gerencie suas etiquetas" no painel Frenet
- ‚úÖ **Salva dados completos** no banco SQLite com campos estruturados
- ‚úÖ **Painel web HTML** responsivo para visualizar pedidos (backup)
- ‚úÖ **Filtros por status** (pending, shipped, delivered, error)
- ‚úÖ **Export JSON** para integra√ß√£o com outras ferramentas
- ‚úÖ **Monitor autom√°tico** verifica entregas periodicamente
- ‚úÖ **Atualiza Bagy** automaticamente quando pedido √© entregue
- ‚úÖ **Retry inteligente** em caso de falhas
- ‚úÖ **Logs detalhados** com emojis para f√°cil visualiza√ß√£o
- ‚úÖ **Health checks** e estat√≠sticas em tempo real
- ‚úÖ **100% pronto para produ√ß√£o**

## ‚úÖ API da Frenet: Shipments

A API da Frenet oferece o endpoint **Shipments** para cria√ß√£o autom√°tica de pedidos:
- ‚úÖ `POST /v1/shipments` - Cria pedido no painel "Gerencie suas etiquetas"
- ‚úÖ `/shipping/quote` - Cota√ß√£o de frete
- ‚úÖ `/tracking/trackinginfo` - Rastreamento

**Como funciona:**
1. Sistema envia pedido via API Shipments
2. Pedido aparece automaticamente no painel Frenet
3. Voc√™ escolhe transportadora e gera etiqueta
4. Sistema monitora rastreio e atualiza Bagy automaticamente

**Documenta√ß√£o:** https://docs.frenet.com.br/docs/shipments-whitelabel

## üìã Requisitos

- Python 3.11+
- Tokens de API:
  - `BAGY_TOKEN` - Token de autentica√ß√£o da Bagy
  - `FRENET_TOKEN` - Token de autentica√ß√£o da Frenet

## üîß Instala√ß√£o Local

### 1. Clone o reposit√≥rio

```bash
git clone <seu-repositorio>
cd <nome-do-projeto>
```

### 2. Crie ambiente virtual

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ou
venv\Scripts\activate  # Windows
```

### 3. Instale depend√™ncias

```bash
pip install -r requirements.txt
```

### 4. Configure vari√°veis de ambiente

```bash
cp .env.example .env
# Edite .env e adicione seus tokens
```

### 5. Execute a aplica√ß√£o

```bash
python main.py
```

A aplica√ß√£o estar√° rodando em `http://localhost:3000`

## üê≥ Deploy com Docker

### Usando Docker Compose (Recomendado)

```bash
# Configure as vari√°veis no .env
cp .env.example .env
nano .env  # Edite com seus tokens

# Inicie o servi√ßo
docker-compose up -d

# Verifique os logs
docker-compose logs -f

# Pare o servi√ßo
docker-compose down
```

### Usando Docker diretamente

```bash
# Build da imagem
docker build -t bagy-frenet-webhook .

# Execute o container
docker run -d \
  -p 3000:3000 \
  -e BAGY_TOKEN="seu_token_aqui" \
  -e FRENET_TOKEN="seu_token_aqui" \
  -e SELLER_CEP="03320-001" \
  -e FORCE_VALUE="10.00" \
  -e FORCE_CARRIER_CODE="LOGGI" \
  -e FORCE_CARRIER_NAME="Entrega Loggi" \
  -v $(pwd)/data:/app/data \
  --name bagy-webhook \
  bagy-frenet-webhook
```

## ‚òÅÔ∏è Deploy em Nuvem

### Railway.app

1. Fa√ßa fork deste reposit√≥rio no GitHub
2. Acesse [Railway.app](https://railway.app) e crie uma conta
3. Clique em **"New Project" ‚Üí "Deploy from GitHub"**
4. Selecione seu reposit√≥rio
5. Adicione as vari√°veis de ambiente:
   - `BAGY_TOKEN`
   - `FRENET_TOKEN`
   - `SELLER_CEP` (opcional)
   - `FORCE_VALUE` (opcional)
   - `FORCE_CARRIER_CODE` (opcional)
   - `FORCE_CARRIER_NAME` (opcional)
6. Aguarde o deploy (Railway detectar√° automaticamente o Procfile)
7. Copie a URL gerada (ex: `https://seu-app.up.railway.app`)

### Render.com

1. Fa√ßa fork deste reposit√≥rio no GitHub
2. Acesse [Render.com](https://render.com) e crie uma conta
3. Clique em **"New +" ‚Üí "Web Service"**
4. Conecte seu reposit√≥rio GitHub
5. Configure:
   - **Build Command:** `pip install -r requirements.txt`
   - **Start Command:** `gunicorn main:app --bind 0.0.0.0:$PORT`
6. Adicione as vari√°veis de ambiente (mesmo que Railway)
7. Clique em **"Create Web Service"**

### Heroku

1. Instale o [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli)
2. Fa√ßa login: `heroku login`
3. Crie o app:

```bash
heroku create seu-app-nome
```

4. Configure vari√°veis:

```bash
heroku config:set BAGY_TOKEN="seu_token"
heroku config:set FRENET_TOKEN="seu_token"
heroku config:set SELLER_CEP="03320-001"
```

5. Fa√ßa deploy:

```bash
git push heroku main
```

## üîó Configura√ß√£o do Webhook na Bagy

Ap√≥s fazer o deploy, configure o webhook na plataforma Bagy:

1. Acesse **Configura√ß√µes ‚Üí Integra√ß√µes ‚Üí Webhooks**
2. Clique em **"Adicionar Webhook"**
3. Configure:
   - **Evento:** `Pedido Faturado` ou `Order Invoiced`
   - **URL:** `https://bagy-frenet-production.up.railway.app/webhook`
   - **M√©todo:** `POST`
   - **Content-Type:** `application/json`
4. Salve e teste enviando um pedido de teste

### URLs Suportadas

O sistema aceita webhooks em **3 endpoints** diferentes para m√°xima compatibilidade:
- `https://seu-app.railway.app/` (raiz)
- `https://seu-app.railway.app/webhook` (recomendado)
- `https://seu-app.railway.app/order`

Todos suportam **GET** e **POST** para compatibilidade com integra√ß√µes nativas.

## üìã Workflow Completo Passo a Passo

### 1Ô∏è‚É£ Cliente faz um pedido na Bagy
- Pedido entra com status "pending" ou "processing"

### 2Ô∏è‚É£ Voc√™ fatura o pedido na Bagy
- Muda status para "invoiced" (faturado)
- Bagy dispara webhook automaticamente

### 3Ô∏è‚É£ Sistema cria pedido automaticamente na Frenet
- Webhook captura dados completos do pedido
- Envia via API Shipments para Frenet
- Pedido √© criado automaticamente
- Salva no banco de dados local (backup)
- Status inicial: `pending`

### 4Ô∏è‚É£ Pedido aparece no painel Frenet
- Acesse [painel.frenet.com.br](https://painel.frenet.com.br)
- V√° em "Gerencie suas etiquetas"
- Pedido est√° l√° automaticamente! üéâ

### 5Ô∏è‚É£ Voc√™ escolhe transportadora e gera etiqueta
- Escolha transportadora (recomendado: Loggi Drop Off)
- Gere a etiqueta
- Imprima e cole no pacote

### 6Ô∏è‚É£ Fa√ßa a postagem
- Leve o pacote ao ponto de coleta
- Ou aguarde coleta no local

### 7Ô∏è‚É£ Sistema monitora automaticamente
- A cada 10 minutos, verifica status no rastreio
- Quando detecta "entregue", atualiza a Bagy
- Pedido fica com status `delivered` no banco

### 8Ô∏è‚É£ Cliente recebe e tudo est√° sincronizado!
- Bagy mostra pedido como entregue
- Frenet tem registro da entrega
- Sistema local tem registro completo
- Processo finalizado ‚úÖ

## üìä Endpoints da API

### `GET /`
Health check b√°sico

**Resposta:**
```json
{
  "status": "online",
  "service": "Webhook Bagy-Frenet",
  "message": "üöÄ Servi√ßo ativo e monitorando pedidos",
  "version": "2.0"
}
```

### `GET /health`
Health check detalhado com estat√≠sticas

**Resposta:**
```json
{
  "status": "healthy",
  "timestamp": "2024-10-30T10:30:00",
  "configuration": {
    "bagy_token_configured": true,
    "frenet_token_configured": true,
    "seller_cep": "03320-001",
    "force_value": 10.0,
    "carrier": "Entrega Loggi",
    "tracker_interval": 600
  },
  "database": {
    "path": "data.db",
    "stats": {
      "created": 5,
      "shipped": 12,
      "delivered": 8,
      "error": 1,
      "total": 26
    }
  }
}
```

### `GET /stats`
Estat√≠sticas de pedidos

**Resposta:**
```json
{
  "statistics": {
    "created": 5,
    "shipped": 12,
    "delivered": 8,
    "error": 1,
    "total": 26
  },
  "timestamp": "2024-10-30T10:30:00"
}
```

### `GET /orders`
üÜï **Painel web para visualizar pedidos salvos**

**Par√¢metros de query:**
- `status` - Filtrar por status: `pending`, `shipped`, `delivered`, `error`, `all` (padr√£o: `pending`)
- `format` - Formato de resposta: `html` (padr√£o), `json`

**Exemplos:**
- `https://seu-app.railway.app/orders` - Painel HTML com pedidos pendentes
- `https://seu-app.railway.app/orders?status=all` - Todos os pedidos
- `https://seu-app.railway.app/orders?status=pending&format=json` - JSON de pendentes

**Resposta HTML:**
Interface web bonita com:
- Cards de pedidos com dados completos
- Filtros por status (pendente, enviado, entregue, erro)
- Informa√ß√µes de cliente, endere√ßo e valores
- Bot√£o para copiar dados
- Design responsivo

**Resposta JSON:**
```json
{
  "orders": [
    {
      "id": 1,
      "bagy_order_id": "12345",
      "bagy_order_code": "TEST-2025-001",
      "status": "pending",
      "customer_name": "Maria Silva",
      "customer_cpf": "12345678901",
      "customer_email": "maria@exemplo.com",
      "customer_phone": "11987654321",
      "address_zipcode": "01310100",
      "address_street": "Avenida Paulista",
      "address_number": "1578",
      "address_complement": "Andar 5",
      "address_neighborhood": "Bela Vista",
      "address_city": "S√£o Paulo",
      "address_state": "SP",
      "total_value": 199.90,
      "shipping_cost": 10.00,
      "tracking_code": null,
      "created_at": "2025-10-30 19:58:40",
      "updated_at": "2025-10-30 19:58:40"
    }
  ],
  "count": 1,
  "status_filter": "pending"
}
```

### `POST /webhook`
Recebe webhooks da Bagy (configurado automaticamente)

**Requisi√ß√£o (enviada pela Bagy):**
```json
{
  "id": "123456",
  "fulfillment_status": "invoiced",
  "customer": {
    "name": "Jo√£o Silva",
    "email": "joao@email.com",
    "phone": "11999999999"
  },
  "address": {
    "zipcode": "01310-100",
    "street": "Av. Paulista, 1000",
    "city": "S√£o Paulo",
    "state": "SP"
  },
  "items": [
    {
      "weight": 1.5,
      "length": 20,
      "height": 10,
      "width": 15,
      "quantity": 2
    }
  ]
}
```

**Resposta (sucesso):**
```json
{
  "success": true,
  "order_id": "123456",
  "tracking_code": "FR123456789BR",
  "message": "Pedido enviado √† Frenet e marcado como enviado na Bagy"
}
```

## ‚öôÔ∏è Vari√°veis de Ambiente

| Vari√°vel | Obrigat√≥ria | Padr√£o | Descri√ß√£o |
|----------|-------------|--------|-----------|
| `BAGY_TOKEN` | ‚úÖ Sim | - | Token de autentica√ß√£o da API Bagy |
| `FRENET_TOKEN` | ‚úÖ Sim | - | Token de autentica√ß√£o da API Frenet |
| `BAGY_BASE` | ‚ùå N√£o | `https://api.dooca.store` | URL base da API Bagy |
| `FRENET_SHIPMENTS_URL` | ‚ùå N√£o | `https://api.frenet.com.br/v1/shipments` | URL da API de cria√ß√£o de pedidos Frenet |
| `FRENET_QUOTE_URL` | ‚ùå N√£o | `https://api.frenet.com.br/shipping/quote` | URL da API de cota√ß√£o Frenet |
| `FRENET_TRACK_URL` | ‚ùå N√£o | `https://api.frenet.com.br/tracking/trackinginfo` | URL da API de rastreio Frenet |
| `SELLER_CEP` | ‚ùå N√£o | `03320-001` | CEP do remetente |
| `FORCE_VALUE` | ‚ùå N√£o | `10.00` | Valor fixo do frete (R$) |
| `FORCE_CARRIER_CODE` | ‚ùå N√£o | `LOG_DRPOFF` | C√≥digo da transportadora (ex: LOG_DRPOFF para Loggi Drop Off) |
| `FORCE_CARRIER_NAME` | ‚ùå N√£o | `Loggi Drop Off` | Nome da transportadora |
| `TRACKER_INTERVAL` | ‚ùå N√£o | `600` | Intervalo de verifica√ß√£o de rastreio (segundos) |
| `DB_PATH` | ‚ùå N√£o | `data.db` | Caminho do banco de dados SQLite |
| `MAX_RETRIES` | ‚ùå N√£o | `3` | N√∫mero m√°ximo de tentativas em caso de erro |
| `REQUEST_TIMEOUT` | ‚ùå N√£o | `30` | Timeout de requisi√ß√µes HTTP (segundos) |
| `PORT` | ‚ùå N√£o | `3000` | Porta do servidor |

### üîå Configura√ß√£o Avan√ßada de Endpoints

A integra√ß√£o √© **flex√≠vel** e permite usar qualquer API de envio!

| Vari√°vel | Padr√£o | Descri√ß√£o |
|----------|--------|-----------|
| `INTEGRATION_TYPE` | `frenet` | Tipo: `frenet`, `loggi`, `kangu`, `custom` |
| `SHIPPING_API_URL` | `https://api.frenet.com.br/shipping/quote` | URL da API de envio |
| `TRACKING_API_URL` | `https://api.frenet.com.br/tracking/trackinginfo` | URL da API de rastreio |

#### Exemplos de configura√ß√£o:

**Usar Frenet (padr√£o):**
```env
INTEGRATION_TYPE=frenet
SHIPPING_API_URL=https://api.frenet.com.br/shipping/quote
```

**Usar Loggi diretamente:**
```env
INTEGRATION_TYPE=loggi
SHIPPING_API_URL=https://api.loggi.com/v1/shipments
FRENET_TOKEN=seu_token_loggi_aqui
```

**Usar Kangu:**
```env
INTEGRATION_TYPE=kangu
SHIPPING_API_URL=https://portal.kangu.com.br/tms/transporte/solicitar
FRENET_TOKEN=seu_token_kangu_aqui
```

**API customizada:**
```env
INTEGRATION_TYPE=custom
SHIPPING_API_URL=https://sua-api.com/v1/criar-envio
TRACKING_API_URL=https://sua-api.com/v1/rastreio
```

#### Headers por tipo de integra√ß√£o:

- **Frenet:** `Authorization: Basic {token}`
- **Loggi:** `Authorization: Bearer {token}`
- **Kangu:** `token: {token}`
- **Custom:** `Authorization: Basic {token}` (padr√£o)

## üîç Logs e Monitoramento

A aplica√ß√£o gera logs detalhados com emojis para facilitar identifica√ß√£o:

```
2024-10-30 10:30:15 - __main__ - INFO - üöÄ INICIANDO WEBHOOK BAGY-FRENET
2024-10-30 10:30:15 - __main__ - INFO - üîß Configura√ß√µes carregadas: SELLER_CEP=03320-001, FORCE_VALUE=R$10.0, CARRIER=Entrega Loggi
2024-10-30 10:30:15 - __main__ - INFO - ‚úÖ Banco de dados inicializado: data.db
2024-10-30 10:30:15 - __main__ - INFO - ‚úÖ Worker de rastreio iniciado
2024-10-30 10:30:15 - __main__ - INFO - üåê Servidor Flask iniciando na porta 3000...
2024-10-30 10:31:22 - __main__ - INFO - üì• Webhook recebido para pedido 123456
2024-10-30 10:31:23 - __main__ - INFO - üöö Enviando pedido 123456 para Frenet...
2024-10-30 10:31:24 - __main__ - INFO - ‚úÖ Pedido 123456 enviado √† Frenet com rastreio: FR123456789BR
2024-10-30 10:31:25 - __main__ - INFO - üì§ Marcando pedido 123456 como enviado na Bagy...
2024-10-30 10:31:26 - __main__ - INFO - ‚úÖ Pedido 123456 marcado como enviado na Bagy
2024-10-30 10:31:26 - __main__ - INFO - ‚úÖ Pedido 123456 processado com sucesso! Rastreio: FR123456789BR
```

### Tipos de log:
- üöÄ Inicializa√ß√£o
- üì• Webhook recebido
- üöö Enviando para Frenet
- üì§ Atualizando Bagy
- üì¶ Entrega confirmada
- ‚úÖ Sucesso
- ‚ö†Ô∏è Avisos
- ‚ùå Erros
- üîç Verifica√ß√µes
- üí§ Aguardando

## üóÑÔ∏è Banco de Dados

A aplica√ß√£o usa SQLite para persist√™ncia. Estrutura da tabela `orders`:

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | INTEGER | ID interno (autoincrement) |
| `bagy_order_id` | TEXT | ID do pedido na Bagy (√∫nico) |
| `tracking_code` | TEXT | C√≥digo de rastreio da Frenet |
| `status` | TEXT | Status: created, shipped, delivered, error |
| `created_at` | TEXT | Data de cria√ß√£o |
| `updated_at` | TEXT | √öltima atualiza√ß√£o |
| `delivered_at` | TEXT | Data de entrega |
| `retry_count` | INTEGER | Contagem de tentativas |
| `last_error` | TEXT | √öltima mensagem de erro |

## üß™ Testes

### Teste local

```bash
# Inicie a aplica√ß√£o
python main.py

# Em outro terminal, teste o webhook
curl -X POST http://localhost:3000/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "id": "TEST-123",
    "fulfillment_status": "invoiced",
    "customer": {"name": "Teste", "email": "teste@email.com", "phone": "11999999999"},
    "address": {"zipcode": "01310-100", "street": "Av. Paulista, 1000", "city": "S√£o Paulo", "state": "SP"},
    "items": [{"weight": 1, "length": 20, "height": 10, "width": 15, "quantity": 1}]
  }'

# Verifique o health check
curl http://localhost:3000/health

# Veja as estat√≠sticas
curl http://localhost:3000/stats
```

## üîí Seguran√ßa

- ‚úÖ Tokens nunca expostos nos logs
- ‚úÖ Valida√ß√£o de dados de entrada
- ‚úÖ Timeout em requisi√ß√µes HTTP
- ‚úÖ Retry com backoff
- ‚úÖ Tratamento robusto de erros
- ‚úÖ Logs detalhados sem informa√ß√µes sens√≠veis

## üêõ Troubleshooting

### Erro: "BAGY_TOKEN n√£o configurado"
**Solu√ß√£o:** Configure a vari√°vel de ambiente `BAGY_TOKEN` com seu token da Bagy.

### Erro: "FRENET_TOKEN n√£o configurado"
**Solu√ß√£o:** Configure a vari√°vel de ambiente `FRENET_TOKEN` com seu token da Frenet.

### Webhook n√£o est√° sendo recebido
**Solu√ß√µes:**
1. Verifique se a URL est√° correta na configura√ß√£o da Bagy
2. Verifique se a aplica√ß√£o est√° rodando e acess√≠vel publicamente
3. Teste manualmente com `curl` para validar

### Pedidos n√£o s√£o marcados como entregues
**Solu√ß√µes:**
1. Verifique os logs para ver se h√° erros na consulta √† Frenet
2. Verifique se `TRACKER_INTERVAL` n√£o est√° muito alto
3. Confirme que o c√≥digo de rastreio est√° correto no banco

### Erro ao conectar com APIs
**Solu√ß√µes:**
1. Verifique sua conex√£o com internet
2. Confirme que os tokens est√£o v√°lidos
3. Verifique se as URLs das APIs est√£o corretas
4. Aumente `REQUEST_TIMEOUT` se necess√°rio

## üìà Performance

- **Retry autom√°tico:** At√© 3 tentativas em caso de falha
- **Worker ass√≠ncrono:** Monitoramento em thread separada
- **Banco indexado:** Queries otimizadas com √≠ndices
- **Timeout configur√°vel:** Evita travamentos
- **Logs eficientes:** Debug opcional para reduzir verbosidade

## ü§ù Contribuindo

Contribui√ß√µes s√£o bem-vindas! Para contribuir:

1. Fork o projeto
2. Crie uma branch: `git checkout -b feature/nova-funcionalidade`
3. Commit suas mudan√ßas: `git commit -m 'Adiciona nova funcionalidade'`
4. Push para a branch: `git push origin feature/nova-funcionalidade`
5. Abra um Pull Request

## üìù Licen√ßa

Este projeto √© de c√≥digo aberto e est√° dispon√≠vel sob a licen√ßa MIT.

## üí° Suporte

Se encontrar problemas ou tiver d√∫vidas:
1. Verifique a se√ß√£o de **Troubleshooting**
2. Consulte os logs da aplica√ß√£o
3. Abra uma issue no GitHub

---

**Desenvolvido com ‚ù§Ô∏è para automatizar integra√ß√µes Bagy-Frenet**
